<% content_for :title, "Channel Subscriptions - Whisperer" %>

<div>
  <!-- Page Header -->
  <div class="mb-6">
    <div class="flex items-center gap-2 text-sm text-base-content/60 mb-2">
      <%= link_to root_path, class: "hover:text-base-content transition-colors" do %>
        <span class="block iconify lucide--home size-4"></span>
      <% end %>
      <span class="iconify lucide--chevron-right size-3"></span>
      <%= link_to "Channels", channels_path, class: "hover:text-base-content transition-colors" %>
      <span class="iconify lucide--chevron-right size-3"></span>
      <span class="text-base-content">Subscriptions</span>
    </div>
    <div class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">Channel Subscriptions</h1>
        <p class="text-base-content/60 text-sm mt-1">
          Manage your YouTube channel subscriptions for <strong><%= @project.name %></strong>
        </p>
      </div>
      <%= link_to new_channels_subscription_path, class: "btn btn-primary btn-sm gap-2" do %>
        <span class="iconify lucide--plus size-4"></span>
        Subscribe
      <% end %>
    </div>
  </div>

  <!-- Subscribed Channels -->
  <div class="bg-base-100 rounded-box border border-base-300 overflow-hidden">
    <div class="px-6 py-4 border-b border-base-300">
      <h2 class="text-lg font-semibold flex items-center gap-2">
        <span class="iconify lucide--rss size-5 text-base-content/70"></span>
        Subscribed Channels
        <span class="badge badge-ghost badge-sm"><%= @channel_subscriptions.size %></span>
      </h2>
    </div>

    <% if @channel_subscriptions.any? %>
      <div class="divide-y divide-base-200">
        <% @channel_subscriptions.each do |subscription| %>
          <div class="p-4 hover:bg-base-50 transition-colors">
            <div class="flex items-start gap-4">
              <!-- Channel Thumbnail -->
              <div class="shrink-0">
                <% if subscription.channel_thumbnail_url.present? %>
                  <%= image_tag subscription.channel_thumbnail_url,
                                alt: subscription.display_name,
                                class: "w-16 h-16 rounded-full object-cover" %>
                <% else %>
                  <div class="w-16 h-16 rounded-full bg-base-200 flex items-center justify-center">
                    <span class="iconify lucide--youtube size-8 text-base-content/30"></span>
                  </div>
                <% end %>
              </div>

              <!-- Channel Info -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <%= link_to "https://youtube.com/channel/#{subscription.channel_id}",
                              target: "_blank",
                              class: "font-semibold text-lg hover:text-primary transition-colors truncate" do %>
                    <%= subscription.display_name %>
                  <% end %>
                  <% case subscription.status %>
                  <% when "active" %>
                    <span class="badge badge-success badge-sm gap-1">
                      <span class="iconify lucide--check size-3"></span>
                      Active
                    </span>
                  <% when "pending" %>
                    <span class="badge badge-warning badge-sm gap-1">
                      <span class="loading loading-spinner loading-xs"></span>
                      Pending
                    </span>
                  <% when "failed" %>
                    <span class="badge badge-error badge-sm gap-1">
                      <span class="iconify lucide--x size-3"></span>
                      Failed
                    </span>
                  <% end %>
                </div>

                <!-- Channel Stats -->
                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-base-content/60 mb-2">
                  <% if subscription.subscriber_count.present? %>
                    <span class="flex items-center gap-1">
                      <span class="iconify lucide--users size-3.5"></span>
                      <%= number_to_human(subscription.subscriber_count, precision: 1, significant: false) %> subscribers
                    </span>
                  <% end %>
                  <% if subscription.video_count.present? %>
                    <span class="flex items-center gap-1">
                      <span class="iconify lucide--video size-3.5"></span>
                      <%= number_to_human(subscription.video_count, precision: 1, significant: false) %> videos
                    </span>
                  <% end %>
                  <span class="flex items-center gap-1 text-primary font-medium">
                    <span class="iconify lucide--download size-3.5"></span>
                    <%= subscription.imported_videos_count %> imported
                  </span>
                </div>

                <!-- Subscription Details -->
                <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-base-content/40">
                  <span class="font-mono"><%= subscription.channel_id %></span>
                  <% if subscription.subscribed_at.present? %>
                    <span>&bull;</span>
                    <span>Subscribed <%= time_ago_in_words(subscription.subscribed_at) %> ago</span>
                  <% end %>
                </div>
              </div>

              <!-- Actions -->
              <div class="flex items-center gap-1 shrink-0">
                <%= link_to "https://youtube.com/channel/#{subscription.channel_id}",
                            target: "_blank",
                            class: "btn btn-ghost btn-sm btn-square",
                            title: "View on YouTube" do %>
                  <span class="iconify lucide--external-link size-4"></span>
                <% end %>
                <%= button_to channels_subscription_path(subscription),
                              method: :delete,
                              class: "btn btn-ghost btn-sm btn-square text-error",
                              title: "Remove subscription",
                              data: { turbo_confirm: "Remove this channel subscription? This won't delete imported videos." } do %>
                  <span class="iconify lucide--trash-2 size-4"></span>
                <% end %>
              </div>
            </div>

            <!-- Recent Imported Videos Preview -->
            <% recent_videos = subscription.recent_videos(limit: 3) %>
            <% if recent_videos.any? %>
              <div class="mt-3 pt-3 border-t border-base-200">
                <p class="text-xs text-base-content/50 mb-2">Recently imported:</p>
                <div class="flex gap-2 overflow-x-auto">
                  <% recent_videos.each do |video| %>
                    <%= link_to video_path(video), class: "shrink-0 group" do %>
                      <div class="relative">
                        <% if video.thumbnail_url.present? %>
                          <%= image_tag video.thumbnail_url,
                                        alt: video.title,
                                        class: "w-24 h-14 object-cover rounded" %>
                        <% else %>
                          <div class="w-24 h-14 bg-base-200 rounded flex items-center justify-center">
                            <span class="iconify lucide--video size-4 text-base-content/30"></span>
                          </div>
                        <% end %>
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center">
                          <span class="iconify lucide--play size-5 text-white"></span>
                        </div>
                      </div>
                      <p class="text-xs text-base-content/70 mt-1 w-24 truncate"><%= video.title %></p>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="px-6 py-12 text-center">
        <span class="iconify lucide--radio size-12 text-base-content/20 mx-auto mb-3"></span>
        <p class="text-base-content/60">No channel subscriptions yet.</p>
        <p class="text-sm text-base-content/40 mt-1">
          <%= link_to "Subscribe to a channel", new_channels_subscription_path, class: "text-primary hover:underline" %>
          to start receiving new video notifications.
        </p>
      </div>
    <% end %>
  </div>
</div>
