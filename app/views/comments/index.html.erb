<% content_for :title, "Comments - Whisperer" %>

<div>
  <!-- Page Header -->
  <div class="mb-6">
    <div class="flex items-center gap-2 text-sm text-base-content/60 mb-2">
      <%= link_to root_path, class: "hover:text-base-content transition-colors" do %>
        <span class="block iconify lucide--home size-4"></span>
      <% end %>
      <span class="iconify lucide--chevron-right size-3"></span>
      <span class="text-base-content">Comments</span>
    </div>
    <div class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">Comments</h1>
        <p class="text-base-content/60 text-sm mt-1">
          <% if current_project %>
            <%= pluralize(@comments.total_count, "comment") %> in <%= current_project.name %>
            <% if any_filters_active? %>
              <span class="text-base-content/40">(filtered)</span>
            <% end %>
          <% else %>
            Select a project to view comments
          <% end %>
        </p>
      </div>
      <% if current_project && @status_check_schedule %>
        <div class="flex items-center gap-2 text-sm shrink-0" id="last_update_info">
          <span class="iconify lucide--refresh-cw size-4 text-base-content/40"></span>
          <% if @status_check_schedule.last_run_at %>
            <span class="text-base-content/50">
              Updated <%= time_ago_in_words(@status_check_schedule.last_run_at) %> ago
            </span>
          <% elsif @status_check_schedule.enabled? %>
            <span class="text-base-content/50">Check scheduled</span>
          <% else %>
            <span class="text-base-content/40">Never checked</span>
          <% end %>
          <span class="text-base-content/20">&middot;</span>
          <%= button_to run_now_job_schedule_path(@status_check_schedule),
                        method: :post,
                        class: "link link-primary text-sm",
                        data: { turbo: false } do %>
            Refresh now
          <% end %>
          <% if @status_check_schedule.enabled? %>
            <span class="text-base-content/20">&middot;</span>
            <span class="text-xs text-success/70">every <%= @status_check_schedule.interval_minutes %> min</span>
          <% else %>
            <span class="text-base-content/20">&middot;</span>
            <%= link_to "Configure", jobs_path, class: "link text-xs text-base-content/50" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <% if current_project.nil? %>
    <div class="alert alert-warning">
      <span class="iconify lucide--alert-triangle size-5"></span>
      <span>Please select a project to view and manage comments.</span>
    </div>
  <% elsif !@has_comments %>
    <!-- Empty State - No comments at all -->
    <div class="bg-base-100 rounded-box border border-base-300 p-12 text-center">
      <span class="iconify lucide--message-circle-off size-16 text-base-content/30 mx-auto mb-4"></span>
      <h3 class="text-lg font-semibold mb-2">No comments yet</h3>
      <p class="text-base-content/60 mb-6">Comments will appear here after importing videos and posting comments.</p>
      <%= link_to import_videos_path, class: "btn btn-primary gap-2" do %>
        <span class="iconify lucide--plus size-4"></span>
        Import Videos
      <% end %>
    </div>
  <% else %>
    <!-- Filter Bar -->
    <%= form_with url: comments_path, method: :get, data: { turbo_frame: "_top" }, class: "mb-4" do %>
      <%= hidden_field_tag :view, view_mode %>
      <div class="bg-base-100 rounded-box border border-base-300 p-4">
        <div class="flex flex-wrap items-center gap-3">
          <!-- Search -->
          <label class="input input-sm input-bordered flex items-center gap-2 flex-1 min-w-[200px]">
            <span class="block iconify lucide--search size-4 text-base-content/40" id="search_icon"></span>
            <span class="loading loading-spinner loading-xs text-base-content/40 hidden" id="search_spinner"></span>
            <input type="text" name="q" value="<%= params[:q] %>"
                   id="comment_search"
                   placeholder="Search comments..."
                   class="grow bg-transparent outline-none"
                   oninput="
                   clearTimeout(this._t);
                     document.getElementById('search_icon').classList.add('hidden');
                     document.getElementById('search_spinner').classList.remove('hidden');
                     this._t = setTimeout(() => this.form.requestSubmit(), 800);
                   "/>
          </label>

          <!-- Appearance -->
          <%= select_tag :appearance,
                         options_for_select([
                                              ["All Appearances", ""],
                                              ["Pending Check", "pending_check"],
                                              ["Top", "top"],
                                              ["Newest", "newest"],
                                              ["Removed", "removed"],
                                            ], params[:appearance]),
                         class: "select select-sm select-bordered",
                         onchange: "this.form.requestSubmit()" %>

          <!-- Source (admin only) -->
          <% if current_user.admin? %>
            <%= select_tag :source,
                           options_for_select([
                                                ["All Sources", ""],
                                                ["API", "via_api"],
                                                ["SMM", "via_smm"],
                                                ["Manual", "manual"]
                                              ], params[:source]),
                           class: "select select-sm select-bordered",
                           onchange: "this.form.requestSubmit()" %>
          <% end %>

          <!-- Video -->
          <%= select_tag :video_id,
                         options_for_select(
                           [["All Videos", ""]] + @videos.map { |v| [v.title&.truncate(35) || "Untitled", v.id] },
                           params[:video_id]
                         ),
                         class: "select select-sm select-bordered max-w-[220px]",
                         onchange: "this.form.requestSubmit()" %>

          <!-- Channel -->
          <%= select_tag :channel_id,
                         options_for_select(
                           [["All Channels", ""]] + @channels.map { |c| [c.name&.truncate(30) || c.youtube_channel_id, c.id] },
                           params[:channel_id]
                         ),
                         class: "select select-sm select-bordered max-w-[200px]",
                         onchange: "this.form.requestSubmit()" %>

          <!-- Replies -->
          <%= select_tag :replies,
                         options_for_select([
                                              ["All Comments", ""],
                                              ["With Replies", "with"],
                                              ["Without Replies", "without"]
                                            ], params[:replies]),
                         class: "select select-sm select-bordered",
                         onchange: "this.form.requestSubmit()" %>

          <!-- Sort -->
          <div class="flex items-center gap-1.5 border-l border-base-300 pl-3">
            <span class="iconify lucide--arrow-up-down size-3.5 text-base-content/40 shrink-0"></span>
            <%= select_tag :sort,
                           options_for_select([
                                                ["Newest", "newest"],
                                                ["Oldest", "oldest"],
                                                ["Most Likes", "likes"],
                                                ["Most Reach", "reach"],
                                                ["Best Rank", "rank"]
                                              ], params[:sort]),
                           class: "select select-sm select-bordered",
                           onchange: "this.form.requestSubmit()" %>
          </div>

          <!-- View Mode Toggle -->
          <div class="flex items-center border-l border-base-300 pl-3">
            <div class="join">
              <button type="submit" name="view" value="flat"
                      class="join-item btn btn-xs <%= view_mode == 'flat' ? 'btn-active' : 'btn-ghost' %>"
                      onclick="document.querySelector('input[name=view]').value='flat'">
                <span class="iconify lucide--list size-4"></span>
              </button>
              <button type="submit" name="view" value="grouped"
                      class="join-item btn btn-xs <%= view_mode == 'grouped' ? 'btn-active' : 'btn-ghost' %>"
                      onclick="document.querySelector('input[name=view]').value='grouped'">
                <span class="iconify lucide--layout-grid size-4"></span>
              </button>
            </div>
          </div>

          <!-- Clear Filters -->
          <% if any_filters_active? %>
            <%= link_to comments_path(view: view_mode), class: "btn btn-ghost btn-sm gap-1 text-base-content/60" do %>
              <span class="iconify lucide--x size-4"></span>
              Clear
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if @comments.empty? %>
      <!-- No Results for current filters -->
      <div class="bg-base-100 rounded-box border border-base-300 p-12 text-center">
        <span class="iconify lucide--search-x size-16 text-base-content/30 mx-auto mb-4"></span>
        <h3 class="text-lg font-semibold mb-2">No comments match your filters</h3>
        <p class="text-base-content/60 mb-6">Try adjusting or clearing your filters.</p>
        <%= link_to comments_path, class: "btn btn-ghost gap-2" do %>
          <span class="iconify lucide--x size-4"></span>
          Clear Filters
        <% end %>
      </div>
    <% else %>
      <!-- Comments List -->
      <% if view_mode == "grouped" %>
        <%= render "comments/grouped_list", grouped_comments: @grouped_comments %>
      <% else %>
        <%= render "comments/flat_list", comments: @comments %>
      <% end %>

      <!-- Pagination -->
      <div class="mt-6 flex justify-center">
        <%= paginate @comments, theme: 'default', params: request.query_parameters.except("page") %>
      </div>
    <% end %>
  <% end %>
</div>

<!-- Subscribe to comment updates for this project -->
<% if current_project %>
  <%= turbo_stream_from "project_#{current_project.id}_comments" %>
<% end %>

<!-- Fixed tooltip for row actions -->
<div id="action_tip"
     class="invisible opacity-0 transition-opacity duration-150 fixed z-[9999] bg-neutral text-neutral-content rounded-sm px-2.5 py-1.5 shadow-lg pointer-events-none whitespace-nowrap text-xs">
  <span id="action_tip_text"></span>
  <div class="absolute left-1/2 -translate-x-1/2 -bottom-1 w-2 h-2 bg-neutral rotate-45"></div>
</div>

<script>
    function showActionTip(el, text) {
        const t = document.getElementById('action_tip');
        document.getElementById('action_tip_text').textContent = text;
        const r = el.getBoundingClientRect();
        t.classList.remove('invisible', 'opacity-0');
        t.classList.add('opacity-100');
        const tr = t.getBoundingClientRect();
        t.style.left = (r.left + r.width / 2 - tr.width / 2) + 'px';
        t.style.top = (r.top - tr.height - 10) + 'px';
    }

    function hideActionTip() {
        const t = document.getElementById('action_tip');
        t.classList.add('invisible', 'opacity-0');
        t.classList.remove('opacity-100');
    }
</script>

<!-- Modal container for reply form -->
<%= turbo_frame_tag "modal" %>

<% if params[:q].present? %>
  <script>
      (() => {
          const el = document.getElementById('comment_search');
          if (el) {
              el.focus();
              el.setSelectionRange(el.value.length, el.value.length);
          }
      })();
  </script>
<% end %>
