<tbody id="comment_<%= comment.id %>" data-controller="collapsible" data-collapsible-expanded-value="false">
<tr class="hover group">
  <td class="max-w-xs">
    <div>
      <div class="line-clamp-2 text-sm" id="comment_text_<%= comment.id %>">
        <%= comment.text %>
      </div>
      <% if comment.text.to_s.length > 120 %>
        <span class="text-xs text-primary cursor-pointer hover:underline"
              id="comment_toggle_<%= comment.id %>"
              onclick="
              const el = document.getElementById('comment_text_<%= comment.id %>');
                const toggle = document.getElementById('comment_toggle_<%= comment.id %>');
                if (el.classList.contains('line-clamp-2')) {
                  el.classList.remove('line-clamp-2');
                  toggle.textContent = 'Show less';
                  } else {
                  el.classList.add('line-clamp-2');
                  toggle.textContent = 'Show more';
                  }
              ">Show more</span>
      <% end %>
      <% if comment.replies.any? %>
        <button type="button"
                class="text-xs text-primary/70 hover:text-primary mt-1 flex items-center gap-1 cursor-pointer transition-colors"
                data-action="click->collapsible#toggle"
                data-collapsible-target="trigger">
          <span class="iconify lucide--chevron-right size-3 transition-transform" data-collapsible-target="icon"></span>
          <span class="iconify lucide--message-circle size-3"></span>
          <%= pluralize(comment.replies.size, "reply") %>
        </button>
      <% end %>
    </div>
  </td>
  <td>
    <% if comment.video %>
      <%= link_to video_path(comment.video), class: "link link-hover text-sm line-clamp-1" do %>
        <%= comment.video.title&.truncate(30) || "Untitled" %>
      <% end %>
    <% else %>
      <span class="text-base-content/50 text-sm">-</span>
    <% end %>
  </td>
  <td class="whitespace-nowrap">
    <div class="flex items-center gap-2">
      <%= author_profile_image(comment) %>
      <span class="text-sm truncate"><%= author_display_name(comment) %></span>
    </div>
  </td>
  <td class="whitespace-nowrap">
    <% post_type_class = case comment.post_type
                         when "via_api" then "badge-info"
                         when "via_smm" then "badge-secondary"
                         when "manual" then "badge-ghost"
                         else "badge-ghost"
                         end %>
    <span class="badge badge-soft badge-outline badge-sm <%= post_type_class %> gap-1 whitespace-nowrap">
      <% case comment.post_type %>
      <% when "via_api" %>
        <span class="iconify lucide--cloud size-3"></span>
          API
      <% when "via_smm" %>
        <span class="iconify lucide--share-2 size-3"></span>
          SMM
      <% when "manual" %>
        <span class="iconify lucide--pen size-3"></span>
          Manual
      <% else %>
        <span class="iconify lucide--help-circle size-3"></span>
          Unknown
      <% end %>
    </span>
  </td>
  <td class="whitespace-nowrap">
    <% badge_class = case comment.status
                     when "visible" then "badge-success"
                     when "hidden" then "badge-warning"
                     when "removed" then "badge-error"
                     else "badge-ghost"
                     end %>
    <span class="badge badge-sm <%= badge_class %> whitespace-nowrap"><%= comment.status %></span>
  </td>
  <td class="text-center whitespace-nowrap">
    <span class="inline-flex items-center gap-1 text-sm">
      <span class="iconify lucide--thumbs-up size-3.5 text-base-content/30"></span>
      <span class="<%= comment.like_count.to_i > 0 ? 'font-medium' : 'text-base-content/40' %>">
        <%= comment.like_count || 0 %>
      </span>
    </span>
  </td>
  <td class="text-center whitespace-nowrap">
    <% if comment.rank.present? %>
      <% rank_badge_class = if comment.rank <= 3
                              "badge-primary"
                            elsif comment.rank <= 10
                              "badge-info badge-outline"
                            else
                              "badge-ghost badge-outline"
                            end %>
      <span class="badge badge-sm <%= rank_badge_class %> whitespace-nowrap">#<%= comment.rank %></span>
    <% else %>
      <span class="text-base-content/40 text-sm">-</span>
    <% end %>
  </td>
  <td class="whitespace-nowrap">
    <span class="text-sm text-base-content/60" title="<%= comment.created_at.strftime('%b %d, %Y %H:%M') %>">
      <%= time_ago_in_words(comment.created_at) %> ago
    </span>
  </td>
  <td>
    <div class="flex items-center gap-1 opacity-0 translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 focus-within:opacity-100 focus-within:translate-x-0 transition-all duration-200 ease-out">
      <% if comment.youtube_comment_id.present? %>
        <%= link_to reply_form_comment_path(comment),
                    class: "btn btn-ghost btn-xs",
                    title: "Add replies",
                    data: { turbo_frame: "modal" } do %>
          <span class="iconify lucide--reply size-4"></span>
        <% end %>
        <button class="btn btn-ghost btn-xs" popovertarget="upvote_pop_<%= comment.id %>" style="anchor-name:--upvote-<%= comment.id %>" title="Add likes via SMM">
          <span class="iconify lucide--thumbs-up size-4"></span>
        </button>
        <%= link_to "https://www.youtube.com/watch?v=#{comment.video&.youtube_id}&lc=#{comment.youtube_comment_id}",
                    target: "_blank",
                    class: "btn btn-ghost btn-xs",
                    title: "View on YouTube" do %>
          <span class="iconify lucide--external-link size-4"></span>
        <% end %>
      <% end %>
    </div>
    <% if comment.youtube_comment_id.present? %>
      <div class="dropdown dropdown-end card card-compact w-52 p-2 shadow bg-base-100 border border-base-300"
           popover id="upvote_pop_<%= comment.id %>" style="position-anchor:--upvote-<%= comment.id %>">
        <%= form_with url: upvote_comment_path(comment), method: :post, class: "flex flex-col gap-2" do |f| %>
          <label class="text-xs font-medium">Add likes via SMM</label>
          <input type="number" name="quantity" value="10" min="1" class="input input-sm input-bordered w-full"/>
          <button type="submit" class="btn btn-sm btn-primary">Order</button>
        <% end %>
      </div>
    <% end %>
  </td>
</tr>
<% if comment.replies.any? %>
  <tr data-collapsible-target="content" class="hidden" id="comment_<%= comment.id %>_replies">
    <td colspan="9" class="!p-0 !bg-transparent">
      <div class="ml-6 my-2 border-l-2 border-primary/20">
        <div class="divide-y divide-base-200/60">
          <% comment.replies.ordered.each do |reply| %>
            <div class="flex items-start gap-3 pl-4 pr-3 py-2.5 group/reply hover:bg-base-200/30 transition-colors">
              <div class="shrink-0 mt-0.5">
                <% if reply.google_account&.avatar_url.present? %>
                  <%= image_tag reply.google_account.avatar_url,
                                referrerpolicy: "no-referrer",
                                class: "w-6 h-6 rounded-full", alt: "" %>
                <% else %>
                  <div class="w-6 h-6 rounded-full bg-base-300 flex items-center justify-center">
                    <span class="iconify lucide--user size-3 text-base-content/40"></span>
                  </div>
                <% end %>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-0.5">
                  <span class="text-xs font-medium"><%= reply.google_account&.display_name || "-" %></span>
                  <span class="text-xs text-base-content/40" title="<%= reply.created_at.strftime('%b %d, %Y %H:%M') %>">
                    <%= time_ago_in_words(reply.created_at) %> ago
                  </span>
                  <% reply_badge_class = case reply.status
                                         when "visible" then "badge-success"
                                         when "hidden" then "badge-warning"
                                         when "removed" then "badge-error"
                                         else "badge-ghost"
                                         end %>
                  <span class="badge badge-xs <%= reply_badge_class %> whitespace-nowrap"><%= reply.status %></span>
                </div>
                <div class="text-sm line-clamp-2"><%= reply.text %></div>
                <div class="flex items-center gap-3 mt-1">
                  <span class="inline-flex items-center gap-1 text-xs text-base-content/50">
                    <span class="iconify lucide--thumbs-up size-3"></span>
                    <span class="<%= reply.like_count.to_i > 0 ? 'font-medium text-base-content/70' : '' %>">
                      <%= reply.like_count || 0 %>
                    </span>
                  </span>
                  <div class="inline-flex items-center gap-1 opacity-0 translate-x-2 group-hover/reply:opacity-100 group-hover/reply:translate-x-0 focus-within:opacity-100 focus-within:translate-x-0 transition-all duration-200 ease-out">
                    <% if reply.youtube_comment_id.present? %>
                      <button class="btn btn-ghost btn-xs btn-circle" popovertarget="upvote_pop_reply_<%= reply.id %>" style="anchor-name:--upvote-reply-<%= reply.id %>" title="Add likes via SMM">
                        <span class="iconify lucide--thumbs-up size-3"></span>
                      </button>
                      <%= link_to "https://www.youtube.com/watch?v=#{reply.video&.youtube_id}&lc=#{reply.youtube_comment_id}",
                                  target: "_blank",
                                  class: "btn btn-ghost btn-xs btn-circle",
                                  title: "View on YouTube" do %>
                        <span class="iconify lucide--external-link size-3"></span>
                      <% end %>
                    <% end %>
                  </div>
                  <% if reply.youtube_comment_id.present? %>
                    <div class="dropdown dropdown-end card card-compact w-52 p-2 shadow bg-base-100 border border-base-300"
                         popover id="upvote_pop_reply_<%= reply.id %>" style="position-anchor:--upvote-reply-<%= reply.id %>">
                      <%= form_with url: upvote_comment_path(reply), method: :post, class: "flex flex-col gap-2" do |f| %>
                        <label class="text-xs font-medium">Add likes via SMM</label>
                        <input type="number" name="quantity" value="10" min="1" class="input input-sm input-bordered w-full"/>
                        <button type="submit" class="btn btn-sm btn-primary">Order</button>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </td>
  </tr>
<% end %>
</tbody>
