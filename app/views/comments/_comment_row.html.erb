<tbody id="comment_<%= comment.id %>" data-controller="collapsible" data-collapsible-expanded-value="false" class="hover:bg-base-200/50">
<tr class="hover group">
  <td class="max-w-xs">
    <div>
      <div class="line-clamp-2 text-sm" id="comment_text_<%= comment.id %>">
        <%= comment.text %>
      </div>
      <% if comment.text.to_s.length > 120 %>
        <span class="text-xs text-primary cursor-pointer hover:underline"
              id="comment_toggle_<%= comment.id %>"
              onclick="
              const el = document.getElementById('comment_text_<%= comment.id %>');
                const toggle = document.getElementById('comment_toggle_<%= comment.id %>');
                if (el.classList.contains('line-clamp-2')) {
                  el.classList.remove('line-clamp-2');
                  toggle.textContent = 'Show less';
                  } else {
                  el.classList.add('line-clamp-2');
                  toggle.textContent = 'Show more';
                  }
              ">Show more</span>
      <% end %>
      <% if comment.replies.any? %>
        <button type="button"
                class="text-xs text-primary/70 hover:text-primary mt-1 flex items-center gap-1 cursor-pointer transition-colors"
                data-action="click->collapsible#toggle"
                data-collapsible-target="trigger">
          <span class="iconify lucide--chevron-right size-3 transition-transform" data-collapsible-target="icon"></span>
          <span class="iconify lucide--message-circle size-3"></span>
          <%= pluralize(comment.replies.size, "reply") %>
        </button>
      <% end %>
    </div>
  </td>
  <td>
    <% if comment.video %>
      <%= link_to video_path(comment.video), class: "link link-hover text-sm line-clamp-1" do %>
        <%= comment.video.title&.truncate(30) || "Untitled" %>
      <% end %>
    <% else %>
      <span class="text-base-content/50 text-sm">-</span>
    <% end %>
  </td>
  <td class="whitespace-nowrap">
    <div class="flex items-center gap-2">
      <%= author_profile_image(comment) %>
      <span class="text-sm truncate"><%= author_display_name(comment) %></span>
    </div>
  </td>
  <td class="whitespace-nowrap text-center">
    <% post_type_class = case comment.post_type
                         when "via_api" then "badge-info"
                         when "via_smm" then "badge-secondary"
                         when "manual" then "badge-ghost"
                         else "badge-ghost"
                         end %>
    <span class="badge badge-soft badge-sm <%= post_type_class %> gap-1 whitespace-nowrap">
      <% case comment.post_type %>
      <% when "via_api" %>
        <span class="iconify lucide--cloud size-3"></span>
          API
      <% when "via_smm" %>
        <span class="iconify lucide--share-2 size-3"></span>
          SMM
      <% when "manual" %>
        <span class="iconify lucide--pen size-3"></span>
          Manual
      <% else %>
        <span class="iconify lucide--help-circle size-3"></span>
          Unknown
      <% end %>
    </span>
  </td>
  <td class="whitespace-nowrap">
    <% badge_class = case comment.appearance
                     when "top" then "badge-success"
                     when "newest" then "badge-warning"
                     when "removed" then "badge-error"
                     else "badge-ghost"
                     end %>
    <span class="badge badge-outline badge-sm <%= badge_class %> whitespace-nowrap"><%= comment.appearance %></span>
  </td>
  <td class="text-center whitespace-nowrap">
    <div class="flex items-center justify-center gap-1 text-sm">
      <span class="iconify lucide--thumbs-up size-3.5 text-base-content"></span>
      <span class="<%= comment.like_count.to_i > 0 ? 'font-sm' : 'text-base-content' %>">
        <%= comment.like_count || 0 %>
      </span>
    </div>
  </td>
  <td class="text-center whitespace-nowrap" style="overflow: visible;">
    <%
      snapshot_data = comment.snapshots.order(:created_at)
                             .select(:rank, :video_views, :like_count, :reach, :created_at)
                             .map { |s| { rank: s.rank, video_views: s.video_views, like_count: s.like_count, reach: s.reach, created_at: s.created_at.iso8601 } }
      total = comment.total_reach || 0
    %>
    <%# snapshot_data = comment.mock_snapshot_data %>
    <%# total = snapshot_data.sum { |s| s[:reach] } %>
    <div id="reach_chart_<%= comment.id %>"
         data-controller="reach-chart"
         data-reach-chart-snapshots-value="<%= snapshot_data.to_json %>"
         class="relative inline-flex flex-col items-center">
      <div data-reach-chart-target="chart"></div>
      <span class="text-[10px] text-base-content/60 mt-0.5">
        <%= number_to_human(total, precision: 2, significant: true, format: "%n%u", units: { thousand: "K", million: "M" }) %>
        reach
      </span>
      <div data-reach-chart-target="tooltip"
           class="invisible opacity-0 transition-opacity duration-150 fixed z-[9999] bg-neutral text-neutral-content rounded-lg px-2.5 py-1.5 shadow-lg pointer-events-none whitespace-nowrap">
      </div>
    </div>
  </td>
  <td class="text-center whitespace-nowrap">
    <% if comment.rank.present? %>
      <% rank_badge_class = if comment.rank <= 3
                              "badge-primary"
                            elsif comment.rank <= 10
                              "badge-info"
                            else
                              "badge-ghost"
                            end %>
      <span class="badge badge-sm <%= rank_badge_class %> whitespace-nowrap">#<%= comment.rank %></span>
    <% else %>
      <span class="text-base-content/40 text-sm">-</span>
    <% end %>
  </td>
  <td class="whitespace-nowrap relative">
    <span class="text-sm text-base-content/60" title="<%= comment.created_at.strftime('%b %d, %Y %H:%M') %>">
      <%= time_ago_in_words(comment.created_at) %> ago
    </span>
    <% if comment.youtube_comment_id.present? %>
      <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1
                  px-2 py-1 rounded-lg bg-base-100 shadow-md border border-base-200
                  opacity-0 translate-x-2 group-hover:opacity-100 group-hover:translate-x-0
                  focus-within:opacity-100 focus-within:translate-x-0
                  transition-all duration-200 ease-out">
        <%= link_to reply_form_comment_path(comment),
                    class: "btn btn-ghost btn-xs",
                    data: { turbo_frame: "modal" },
                    onmouseenter: "showActionTip(this, 'Reply')",
                    onmouseleave: "hideActionTip()" do %>
          <span class="iconify lucide--reply size-4"></span>
        <% end %>
        <button class="btn btn-ghost btn-xs" popovertarget="upvote_pop_<%= comment.id %>" style="anchor-name:--upvote-<%= comment.id %>"
                onmouseenter="showActionTip(this, 'Upvote via SMM')"
                onmouseleave="hideActionTip()">
          <span class="iconify lucide--thumbs-up size-4"></span>
        </button>
        <button class="btn btn-ghost btn-xs"
                onmouseenter="showActionTip(this, 'Copy URL')"
                onmouseleave="hideActionTip()"
                onclick="
                navigator.clipboard.writeText('https://www.youtube.com/watch?v=<%= comment.video&.youtube_id %>&lc=<%= comment.youtube_comment_id %>');
                  showActionTip(this, 'Copied!');
                  setTimeout(() => showActionTip(this, 'Copy URL'), 1500);
                ">
          <span class="iconify lucide--link size-4"></span>
        </button>
        <%= link_to "https://www.youtube.com/watch?v=#{comment.video&.youtube_id}&lc=#{comment.youtube_comment_id}",
                    target: "_blank",
                    class: "btn btn-ghost btn-xs",
                    onmouseenter: "showActionTip(this, 'Open on YouTube')",
                    onmouseleave: "hideActionTip()" do %>
          <span class="iconify lucide--external-link size-4"></span>
        <% end %>
      </div>
      <div class="dropdown dropdown-end card card-compact w-52 p-2 shadow bg-base-100 border border-base-300"
           popover id="upvote_pop_<%= comment.id %>" style="position-anchor:--upvote-<%= comment.id %>">
        <%= form_with url: upvote_comment_path(comment), method: :post, class: "flex flex-col gap-2" do |f| %>
          <label class="text-xs font-medium">Add likes via SMM</label>
          <input type="number" name="quantity" value="10" min="1" class="input input-sm input-bordered w-full"/>
          <button type="submit" class="btn btn-sm btn-primary">Order</button>
        <% end %>
      </div>
    <% end %>
  </td>
</tr>
<% if comment.replies.any? %>
  <tr data-collapsible-target="content" class="hidden" id="comment_<%= comment.id %>_replies">
    <td colspan="9" class="!p-0 !bg-transparent">
      <div class="ml-6 my-2 border-l-2 border-primary/20">
        <div class="divide-y divide-base-200/60">
          <% comment.replies.ordered.each do |reply| %>
            <%= render partial: "comments/reply_row", locals: { reply: reply } %>
          <% end %>
        </div>
      </div>
    </td>
  </tr>
<% end %>
</tbody>
