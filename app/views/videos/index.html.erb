<% content_for :title, "Videos - Whisperer" %>

<div data-controller="video-selection">
  <!-- Page Header -->
  <div class="mb-6">
    <div class="flex items-center gap-2 text-sm text-base-content/60 mb-2">
      <%= link_to root_path, class: "hover:text-base-content transition-colors" do %>
        <span class="block iconify lucide--home size-4"></span>
      <% end %>
      <span class="iconify lucide--chevron-right size-3"></span>
      <span class="text-base-content">Videos</span>
    </div>
    <div class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">Videos</h1>
        <p class="text-base-content/60 text-sm mt-1">
          <% if current_project %>
            <%= pluralize(@videos.total_count, "video") %> in <%= current_project.name %>
          <% else %>
            Select a project to view videos
          <% end %>
        </p>
      </div>
      <div class="flex items-center gap-2">
        <%= link_to import_videos_path, class: "btn btn-primary btn-sm gap-2" do %>
          <span class="iconify lucide--plus size-4"></span>
          Import Videos
        <% end %>
      </div>
    </div>
  </div>

  <% if current_project.nil? %>
    <div class="alert alert-warning">
      <span class="iconify lucide--alert-triangle size-5"></span>
      <span>Please select a project to view and manage videos.</span>
    </div>
  <% else %>
    <!-- Filter Bar -->
    <div class="flex items-center justify-between gap-4 mb-4">
      <div class="flex items-center gap-3">
        <!-- Filter Dropdown -->
        <div class="flex items-center gap-2">
          <%= form_with url: videos_path, method: :get, data: { turbo_frame: "_top" }, class: "inline flex center gap-2" do |f| %>
            <%= label_tag :filter, "Filter:", class: "text-sm text-base-content/60" %>
            <%= select_tag :filter,
                           options_for_select([
                                                ["All Videos", ""],
                                                ["No Comments", "no_comments"],
                                                ["Has Comments", "has_comments"],
                                                ["With Visible", "visible"],
                                                ["With Hidden", "hidden"],
                                                ["With Removed", "removed"]
                                              ], @filter),
                           class: "select select-sm select-bordered",
                           onchange: "this.form.submit()" %>
          <% end %>
        </div>

        <!-- Selection Info -->
        <div class="text-sm text-base-content/60" data-video-selection-target="selectionInfo">
          <!-- Updated by Stimulus -->
        </div>
      </div>

      <!-- Bulk Actions -->
      <div class="flex items-center gap-2 hidden" data-video-selection-target="bulkActions">
        <%= form_with url: bulk_post_comments_videos_path, method: :post, data: { turbo: true } do |f| %>
          <div data-video-selection-target="videoIdsContainer"></div>
          <%= button_tag type: :submit, class: "btn btn-secondary btn-sm gap-2" do %>
            <span class="iconify lucide--message-square-plus size-4"></span>
            Post Comments
          <% end %>
        <% end %>
        <%= form_with url: bulk_search_related_videos_path, method: :post, data: { turbo: true } do |f| %>
          <div data-video-selection-target="videoIdsContainer"></div>
          <%= button_tag type: :submit, class: "btn btn-accent btn-sm gap-2" do %>
            <span class="iconify lucide--search size-4"></span>
            Find Related
          <% end %>
        <% end %>
      </div>
    </div>

    <% if @videos.empty? %>
      <!-- Empty State (after filter) -->
      <div class="bg-base-100 rounded-box border border-base-300 p-12 text-center">
        <span class="iconify lucide--filter-x size-16 text-base-content/30 mx-auto mb-4"></span>
        <h3 class="text-lg font-semibold mb-2">No videos match filter</h3>
        <p class="text-base-content/60 mb-6">Try changing the filter or import more videos.</p>
        <%= link_to videos_path, class: "btn btn-ghost gap-2" do %>
          <span class="iconify lucide--x size-4"></span>
          Clear Filter
        <% end %>
      </div>
    <% else %>
      <!-- Videos Table -->
      <div class="bg-base-100 rounded-box border border-base-300 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="table table-sm">
            <thead>
            <tr class="bg-base-200/50">
              <th class="w-10 text-center">
                <%= label_tag :select_all_videos, "Select all videos", class: "sr-only" %>
                <%= check_box_tag :select_all_videos,
                                  "1",
                                  false,
                                  class: "checkbox checkbox-sm",
                                  data: { video_selection_target: "selectAll", action: "change->video-selection#toggleAll" } %>
              </th>
              <th class="w-20">Thumb</th>
              <th>Video</th>
              <th class="text-center w-24">Activity</th>
              <th class="text-center w-24">Comments</th>
              <th class="text-center w-32">Status</th>
              <th class="text-center w-20">Likes</th>
              <th class="text-center w-20">Rank</th>
              <th class="w-24"></th>
            </tr>
            </thead>
            <tbody>
            <% @videos.each do |video| %>
              <tr class="hover:bg-base-200/30">
                <!-- Checkbox -->
                <td class="text-center">
                  <%= label_tag "select_video_#{video.id}", "Select #{video.title&.truncate(30) || 'video'}", class: "sr-only" %>
                  <%= check_box_tag "select_video_#{video.id}",
                                    video.id,
                                    false,
                                    class: "checkbox checkbox-sm",
                                    data: { video_selection_target: "checkbox", action: "change->video-selection#updateSelection", video_id: video.id } %>
                </td>

                <!-- Thumbnail -->
                <td class="p-2">
                  <%= link_to "https://youtube.com/watch?v=#{video.youtube_id}", target: "_blank", class: "block" do %>
                    <% if video.thumbnail_url.present? %>
                      <%= image_tag video.thumbnail_url, alt: video.title, class: "w-16 h-10 object-cover rounded" %>
                    <% else %>
                      <div class="w-16 h-10 bg-base-200 rounded flex items-center justify-center">
                        <span class="iconify lucide--video size-4 text-base-content/30"></span>
                      </div>
                    <% end %>
                  <% end %>
                </td>

                <!-- Title & Info -->
                <td class="max-w-xs">
                  <%= link_to "https://youtube.com/watch?v=#{video.youtube_id}",
                              target: "_blank",
                              class: "font-medium text-sm line-clamp-2 hover:text-primary transition-colors",
                              title: video.title do %>
                    <%= video.title || "Untitled" %>
                  <% end %>
                  <div class="flex flex-wrap items-center gap-x-3 gap-y-0.5 mt-0.5 text-xs text-base-content/40">
                    <% if video.channel&.name.present? %>
                      <span class="truncate max-w-32" title="<%= video.channel.name %>"><%= video.channel.name %></span>
                    <% end %>
                    <% if video.published_at.present? %>
                      <span title="Published <%= video.published_at.strftime('%b %d, %Y %H:%M') %>"><%= video.published_at.strftime('%b %d, %Y') %></span>
                    <% end %>
                    <% if video.view_count.to_i > 0 %>
                      <span><%= number_to_human(video.view_count, precision: 1, significant: false) %> views</span>
                    <% end %>
                    <% if video.comment_count.to_i > 0 %>
                      <span><%= number_to_human(video.comment_count, precision: 1, significant: false) %> comments</span>
                    <% end %>
                    <span title="Added to DB <%= video.created_at.strftime('%b %d, %Y %H:%M') %>">Added <%= time_ago_in_words(video.created_at) %> ago</span>
                  </div>
                </td>

                <!-- Comment Activity Sparkline (lazy loaded) -->
                <td class="text-center">
                  <% enable_comment_frequency = false %>
                  <% if enable_comment_frequency %>
                    <%= turbo_frame_tag "video_#{video.id}_sparkline",
                                        src: comment_frequency_video_path(video),
                                        loading: :lazy do %>
                      <div class="flex items-center justify-center h-6">
                        <span class="loading loading-dots loading-xs text-base-content/30"></span>
                      </div>
                    <% end %>
                  <% else %>
                    <span class="text-base-content/40">-</span>
                  <% end %>
                </td>

                <!-- App Comments Count -->
                <td class="text-center">
                  <% if video.app_comments_count.to_i > 0 %>
                    <span class="font-semibold"><%= video.app_comments_count %></span>
                  <% else %>
                    <span class="text-base-content/40">-</span>
                  <% end %>
                </td>

                <!-- Status Breakdown -->
                <td class="text-center">
                  <% if video.app_comments_count.to_i > 0 %>
                    <div class="flex items-center justify-center gap-1.5 text-xs">
                      <% if video.visible_comments_count.to_i > 0 %>
                        <span class="badge badge-success badge-xs gap-0.5" title="Visible">
                          <%= video.visible_comments_count %>
                        </span>
                      <% end %>
                      <% if video.hidden_comments_count.to_i > 0 %>
                        <span class="badge badge-warning badge-xs gap-0.5" title="Hidden">
                          <%= video.hidden_comments_count %>
                        </span>
                      <% end %>
                      <% if video.removed_comments_count.to_i > 0 %>
                        <span class="badge badge-error badge-xs gap-0.5" title="Removed">
                          <%= video.removed_comments_count %>
                        </span>
                      <% end %>
                    </div>
                  <% else %>
                    <span class="text-base-content/40">-</span>
                  <% end %>
                </td>

                <!-- Total Likes on Our Comments -->
                <td class="text-center">
                  <% if video.total_comment_likes.to_i > 0 %>
                    <div class="flex items-center justify-center gap-1 text-sm">
                      <span class="iconify lucide--thumbs-up size-3.5 text-base-content/60"></span>
                      <span><%= video.total_comment_likes %></span>
                    </div>
                  <% else %>
                    <span class="text-base-content/40">-</span>
                  <% end %>
                </td>

                <!-- Best Rank -->
                <td class="text-center">
                  <% if video.best_rank.present? %>
                    <span class="badge badge-ghost badge-sm">#<%= video.best_rank %></span>
                  <% else %>
                    <span class="text-base-content/40">-</span>
                  <% end %>
                </td>

                <!-- Actions -->
                <td class="text-right">
                  <div class="flex items-center justify-end gap-1">
                    <%= link_to video_path(video), class: "btn btn-ghost btn-xs btn-square", title: "Details" do %>
                      <span class="iconify lucide--eye size-4"></span>
                    <% end %>
                    <%= button_to video_path(video),
                                  method: :delete,
                                  class: "btn btn-ghost btn-xs btn-square text-error",
                                  title: "Remove",
                                  data: { turbo_confirm: "Remove this video?" } do %>
                      <span class="iconify lucide--trash-2 size-4"></span>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <div class="mt-4 flex justify-center">
        <%= paginate @videos, theme: 'default', params: { filter: @filter } %>
      </div>
    <% end %>
  <% end %>

</div>